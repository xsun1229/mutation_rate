---
title: "Cross Validation -- MSSNG: half training and half testing, bin size: 100bp"
author: "XSun"
date: "2024-09-06"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
---

# Introduction

We cleaned the real data [here](https://xsun1229.github.io/mutation_rate/denovo0422_realdata_data_cleaning_mssng.html). 

```{r warning=F, message=F}
library(ggplot2)
library(gridExtra)
library(data.table)

scatter_plot_mutct <- function(data, xcol, ycol, title=NULL) {
  # Fit the linear model using user-defined columns
  formula <- as.formula(paste(ycol, "~", xcol, "+0"))
  fit <- lm(formula, data = data)
  adj_rsq <- summary(fit)$adj.r.squared  # Extract the adjusted R-squared

  x_values <- data[[xcol]]
  y_values <- data[[ycol]]

  # Calculate the LPD (Log Predictive Density)
  lpd <- sum(y_values * log(x_values),na.rm = T) - sum(x_values)
  
  ggplot(data) +
  geom_point(data = data, aes_string(x = xcol, y = ycol), color = "black") +
  geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
  annotate("text", x = Inf, y = Inf, label = paste0("Adj R-sq = ", round(adj_rsq, 3), 
                                                    "\nLPD = ", round(lpd, 3)),
           hjust = 1.1, vjust = 1.1, color = "blue", parse = FALSE) +  # Adjust text positioning and color
  labs(x = paste("Predicted mutation count:", xcol),
       y = paste("Observed mutation count:", ycol),
       title = title) +
  theme_minimal()
  
}

# scatter_plot_mutct <- function(data, xcol, ycol, title=NULL) {
#   # Fit the linear model using user-defined columns
#   formula <- as.formula(paste(ycol, "~", xcol, "+0"))
#   fit <- lm(formula, data = data)
#   adj_rsq <- summary(fit)$adj.r.squared  # Extract the adjusted R-squared
#   
#   ggplot(data) +
#   geom_point(data = data, aes_string(x = xcol, y = ycol),color = "black") +
#   geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
#   annotate("text", x = Inf, y = Inf, label = paste0("Adj R-sq = ", round(adj_rsq, 3)),
#            hjust = 1.1, vjust = 1.1, color = "blue", parse = FALSE) +  # Adjust text positioning and color
#   labs(x = paste("Predicted mutation count:", xcol),
#        y = paste("Observed mutation count:", ycol),
#        title = title) +
#   theme_minimal()
#   
# }

plot_scatter_randeff <- function(data) {
  ggplot(data = df_compare) +aes(x=seg_est,y=chr_est) +
  geom_point() +
  labs(x = "random effects estimated from partitioned segments",
       y= "random effects estimated from whole chromosome") +
  geom_abline(slope = 1, intercept = 0, col="red") +
  theme_minimal()
}

plot_randeff_genome <- function(data) {
  ggplot(df_compare, aes(x =  window_start/1000000)) +
  geom_line(aes(y = seg_est, color = "estimated from partitioned segments"), alpha = 0.4) +
  geom_line(aes(y = chr_est, color = "estimated from whole chr"), alpha = 0.3) +
  geom_line(aes(y = fold_change, color = "observed fold change"), alpha = 0.1) +
  labs(x = "gemonic position (mb)",
       y = "estimated random effects") +
  scale_color_manual(name = "Group",
                     values = c("estimated from partitioned segments" = "blue",
                                "estimated from whole chr" = "green", "observed fold change" = "red"),
                     labels = c("estimated from partitioned segments","estimated from whole chr", "observed fold change")) +
  theme_minimal()
}

```



# Setting one: partition the gaps based on large gaps 

* For large gap: treat as different segments. So for chr1, there will be 3 segments. 
* For small gaps like 50kb, treat them as continuous ones. 

<!-- ## The whole window prediction -->

<!-- * Run smashgen on the whole window, to get an estimation for the local random effects  -->

<!-- `fit = ebps(df_seg_non0$obs_sum,df_seg_non0$rl_rescaled_sum,smooth_control = list(wave_trans='ndwt',ndwt_method='smash'), general_control = list(verbose=T,printevery=1, maxiter=50))` -->

<!-- * Predict the mutation rate on the whole window, based on the rescaled Roulette estimation. -->

<!-- `df_per_window_data$sum_pred <- df_per_window_data$randeff_est*df_per_window_data$rl_rescaled_sum` -->

<!-- ### 10kb -->

<!-- ```{r} -->

<!-- load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_10kb_fitted_testpred_halftt_binsz_100.rdata") -->

<!-- df_per_window_data$sum_pred <- df_per_window_data$randeff_est*df_per_window_data$rl_rescaled_sum -->
<!-- data <- df_per_window_data[complete.cases(df_per_window_data$test_pred),] -->

<!-- DT::datatable(data,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Details for each window'),options = list(pageLength = 5) ) -->

<!-- p1 <- scatter_plot_mutct(data = data, xcol = "sum_pred", ycol = "obs_sum",title = "smashgen prediction") -->
<!-- p2 <- scatter_plot_mutct(data = data, xcol = "rl_rescaled_sum", ycol = "obs_sum",title = "Roulette baseline") -->

<!-- grid.arrange(p1, p2, ncol = 2) -->
<!-- ``` -->

<!-- ### 30kb -->

<!-- ```{r} -->

<!-- load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_30kb_fitted_testpred_halftt_binsz_100.rdata") -->

<!-- df_per_window_data$sum_pred <- df_per_window_data$randeff_est*df_per_window_data$rl_rescaled_sum -->
<!-- data <- df_per_window_data[complete.cases(df_per_window_data$test_pred),] -->

<!-- DT::datatable(data,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Details for each window'),options = list(pageLength = 5) ) -->

<!-- p1 <- scatter_plot_mutct(data = data, xcol = "sum_pred", ycol = "obs_sum",title = "smashgen prediction") -->
<!-- p2 <- scatter_plot_mutct(data = data, xcol = "rl_rescaled_sum", ycol = "obs_sum",title = "Roulette baseline") -->

<!-- grid.arrange(p1, p2, ncol = 2) -->
<!-- ``` -->

<!-- ### 50kb -->

<!-- ```{r} -->

<!-- load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_50kb_fitted_testpred_halftt_binsz_100.rdata") -->

<!-- df_per_window_data$sum_pred <- df_per_window_data$randeff_est*df_per_window_data$rl_rescaled_sum -->
<!-- data <- df_per_window_data[complete.cases(df_per_window_data$test_pred),] -->

<!-- DT::datatable(data,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Details for each window'),options = list(pageLength = 5) ) -->

<!-- p1 <- scatter_plot_mutct(data = data, xcol = "sum_pred", ycol = "obs_sum",title = "smashgen prediction") -->
<!-- p2 <- scatter_plot_mutct(data = data, xcol = "rl_rescaled_sum", ycol = "obs_sum",title = "Roulette baseline") -->

<!-- grid.arrange(p1, p2, ncol = 2) -->
<!-- ``` -->


<!-- ### 100kb -->

<!-- ```{r} -->

<!-- load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_100kb_fitted_testpred_halftt_binsz_100.rdata") -->

<!-- df_per_window_data$sum_pred <- df_per_window_data$randeff_est*df_per_window_data$rl_rescaled_sum -->
<!-- data <- df_per_window_data[complete.cases(df_per_window_data$test_pred),] -->

<!-- DT::datatable(data,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Details for each window'),options = list(pageLength = 5) ) -->

<!-- p1 <- scatter_plot_mutct(data = data, xcol = "sum_pred", ycol = "obs_sum",title = "smashgen prediction") -->
<!-- p2 <- scatter_plot_mutct(data = data, xcol = "rl_rescaled_sum", ycol = "obs_sum",title = "Roulette baseline") -->

<!-- grid.arrange(p1, p2, ncol = 2) -->
<!-- ``` -->

## Cross validation

We partition each window into 100bp bins, use odd bins to train the local effect, and test on the even bins

* Run smashgen on the training data, to get an estimation for the local random effects 

`fit = ebps(df_seg_non0$obs_train,df_seg_non0$rl_rescaled_train,smooth_control = list(wave_trans='ndwt',ndwt_method='smash'), general_control = list(verbose=T,printevery=1, maxiter=50))`

* Predict the mutation rate on testing data, based on the rescaled Roulette estimation.

`df_per_window_data$test_pred <- df_per_window_data$randeff_est_train*df_per_window_data$rl_rescaled_test`



### 10kb

```{r}

load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_10kb_fitted_testpred_halftt_binsz_100.rdata")

data <- df_per_window_data[complete.cases(df_per_window_data$test_pred),]

DT::datatable(data,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Details for each window'),options = list(pageLength = 5) )

p1 <- scatter_plot_mutct(data = data, xcol = "test_pred", ycol = "obs_test",title = "smashgen prediction")
p2 <- scatter_plot_mutct(data = data, xcol = "rl_rescaled_test", ycol = "obs_test",title = "Roulette baseline")

grid.arrange(p1, p2, ncol = 2)
```

### 30kb

```{r}

load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_30kb_fitted_testpred_halftt_binsz_100.rdata")

data <- df_per_window_data[complete.cases(df_per_window_data$test_pred),]

DT::datatable(data,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Details for each window'),options = list(pageLength = 5) )

p1 <- scatter_plot_mutct(data = data, xcol = "test_pred", ycol = "obs_test",title = "smashgen prediction")
p2 <- scatter_plot_mutct(data = data, xcol = "rl_rescaled_test", ycol = "obs_test",title = "Roulette baseline")

grid.arrange(p1, p2, ncol = 2)
```


### 50kb

```{r}

load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_50kb_fitted_testpred_halftt_binsz_100.rdata")

data <- df_per_window_data[complete.cases(df_per_window_data$test_pred),]

DT::datatable(data,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Details for each window'),options = list(pageLength = 5) )

p1 <- scatter_plot_mutct(data = data, xcol = "test_pred", ycol = "obs_test",title = "smashgen prediction")
p2 <- scatter_plot_mutct(data = data, xcol = "rl_rescaled_test", ycol = "obs_test",title = "Roulette baseline")

grid.arrange(p1, p2, ncol = 2)
```


### 100kb

```{r}

load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_100kb_fitted_testpred_halftt_binsz_100.rdata")

data <- df_per_window_data[complete.cases(df_per_window_data$test_pred),]

DT::datatable(data,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Details for each window'),options = list(pageLength = 5) )


p1 <- scatter_plot_mutct(data = data, xcol = "test_pred", ycol = "obs_test",title = "smashgen prediction")
p2 <- scatter_plot_mutct(data = data, xcol = "rl_rescaled_test", ycol = "obs_test",title = "Roulette baseline")

grid.arrange(p1, p2, ncol = 2)
```

There are some windows with large observed mutation rate on testing set, but their expected rates are very low.

```{r}

data_large <- data[order(data$obs_test,decreasing = T),][1:5,]
data_large <- data_large[order(data_large$obs_test, decreasing = T),]

colnames(data_large)[c(7,10,13,16)] <- c("rl_rescaled_wholewindow","obs_wholewindow","foldchange_wholewindow","randeff_est_wholewindow")
DT::datatable(data_large,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','windows with large observed mutation rate on testing set, but low expected rates'),options = list(pageLength = 10) )
```
We look into the window 2254. We varied the bin sizes (500bp, 1kb, 2kb) and checked how this window is divided. 

```{r}
obs <- fread("/project/xinhe/xsun/mutation_rate/data/trost_denovo/processed/alltype.mssng.bed")
colnames(obs) <- c("CHROM","START","REF","ALT")
obs_window <- obs[obs$START > 225310007 & obs$START < 225410006 & obs$CHROM ==1, ]

start_window <- 225310007
end_window <- 225410006
bin_sizes <- c(500, 1000, 2000)

# Function to assign training or testing based on bin size
assign_bin_varying_size <- function(start_position, bin_size) {
  bins <- seq(start_window, end_window, by = bin_size)
  bin_index <- findInterval(start_position, bins)
  if (bin_index %% 2 == 1) {
    return("training")
  } else {
    return("testing")
  }
}

# Loop over the different bin sizes and add a new column for each
for (bin_size in bin_sizes) {
  column_name <- paste0("set_", bin_size)
  obs_window[[column_name]] <- sapply(obs_window$START, assign_bin_varying_size, bin_size = bin_size)
}

DT::datatable(obs_window,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','how the window is divided when bin size varies'),options = list(pageLength = 10) )

sprintf("bin size 500bp, number of training= %s, number of testing = %s",sum(obs_window$set_500 =="training"),sum(obs_window$set_500 =="testing"))
sprintf("bin size 1000bp, number of training= %s, number of testing = %s",sum(obs_window$set_1000 =="training"),sum(obs_window$set_1000 =="testing"))
sprintf("bin size 2000bp, number of training= %s, number of testing = %s",sum(obs_window$set_2000 =="training"),sum(obs_window$set_2000 =="testing"))

```

We also look into the window 315. 

```{r}
obs_window <- obs[obs$START > 31410007 & obs$START < 31510006 & obs$CHROM ==1, ]

start_window <- 31410007
end_window <- 31510006
bin_sizes <- c(500, 1000, 2000)

# Function to assign training or testing based on bin size
assign_bin_varying_size <- function(start_position, bin_size) {
  bins <- seq(start_window, end_window, by = bin_size)
  bin_index <- findInterval(start_position, bins)
  if (bin_index %% 2 == 1) {
    return("training")
  } else {
    return("testing")
  }
}

# Loop over the different bin sizes and add a new column for each
for (bin_size in bin_sizes) {
  column_name <- paste0("set_", bin_size)
  obs_window[[column_name]] <- sapply(obs_window$START, assign_bin_varying_size, bin_size = bin_size)
}

DT::datatable(obs_window,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','how the window is divided when bin size varies'),options = list(pageLength = 10) )

sprintf("bin size 500bp, number of training= %s, number of testing = %s",sum(obs_window$set_500 =="training"),sum(obs_window$set_500 =="testing"))
sprintf("bin size 1000bp, number of training= %s, number of testing = %s",sum(obs_window$set_1000 =="training"),sum(obs_window$set_1000 =="testing"))
sprintf("bin size 2000bp, number of training= %s, number of testing = %s",sum(obs_window$set_2000 =="training"),sum(obs_window$set_2000 =="testing"))
```


There are also some windows having high predicted rates but low observed mutations on testing set. 

```{r}

data_small <- data[order(data$test_pred,decreasing = T),][1:10,]

colnames(data_small)[c(7,10,13,16)] <- c("rl_rescaled_wholewindow","obs_wholewindow","foldchange_wholewindow","randeff_est_wholewindow")
DT::datatable(data_small,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','windows with large expected rates'),options = list(pageLength = 10) )
```
We look into the window 454. 

```{r}
obs_window <- obs[obs$START > 45310007 & obs$START < 45410006 & obs$CHROM ==1, ]

start_window <- 45310007
end_window <- 45410006
bin_sizes <- c(500, 1000, 2000)

# Function to assign training or testing based on bin size
assign_bin_varying_size <- function(start_position, bin_size) {
  bins <- seq(start_window, end_window, by = bin_size)
  bin_index <- findInterval(start_position, bins)
  if (bin_index %% 2 == 1) {
    return("training")
  } else {
    return("testing")
  }
}

# Loop over the different bin sizes and add a new column for each
for (bin_size in bin_sizes) {
  column_name <- paste0("set_", bin_size)
  obs_window[[column_name]] <- sapply(obs_window$START, assign_bin_varying_size, bin_size = bin_size)
}

DT::datatable(obs_window,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','how the window is divided when bin size varies'),options = list(pageLength = 10) )

sprintf("bin size 500bp, number of training= %s, number of testing = %s",sum(obs_window$set_500 =="training"),sum(obs_window$set_500 =="testing"))
sprintf("bin size 1000bp, number of training= %s, number of testing = %s",sum(obs_window$set_1000 =="training"),sum(obs_window$set_1000 =="testing"))
sprintf("bin size 2000bp, number of training= %s, number of testing = %s",sum(obs_window$set_2000 =="training"),sum(obs_window$set_2000 =="testing"))
```


<!-- # Setting two: treat the whole genome as one segment -->

<!-- <!-- ## The whole window prediction --> -->

<!-- <!-- ### 10kb --> -->

<!-- <!-- ```{r} --> -->

<!-- <!-- load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_10kb_fitted_testpred_chr_halftt_binsz_100.rdata") --> -->

<!-- <!-- df_per_window_data$sum_pred <- df_per_window_data$randeff_est*df_per_window_data$rl_rescaled_sum --> -->
<!-- <!-- data <- df_per_window_data[complete.cases(df_per_window_data$test_pred),] --> -->

<!-- <!-- DT::datatable(data,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Details for each window'),options = list(pageLength = 5) ) --> -->

<!-- <!-- p1 <- scatter_plot_mutct(data = data, xcol = "sum_pred", ycol = "obs_sum",title = "smashgen prediction") --> -->
<!-- <!-- p2 <- scatter_plot_mutct(data = data, xcol = "rl_rescaled_sum", ycol = "obs_sum",title = "Roulette baseline") --> -->

<!-- <!-- grid.arrange(p1, p2, ncol = 2) --> -->
<!-- <!-- ``` --> -->

<!-- <!-- ### 30kb --> -->

<!-- <!-- ```{r} --> -->

<!-- <!-- load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_30kb_fitted_testpred_chr_halftt_binsz_100.rdata") --> -->

<!-- <!-- df_per_window_data$sum_pred <- df_per_window_data$randeff_est*df_per_window_data$rl_rescaled_sum --> -->
<!-- <!-- data <- df_per_window_data[complete.cases(df_per_window_data$test_pred),] --> -->

<!-- <!-- DT::datatable(data,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Details for each window'),options = list(pageLength = 5) ) --> -->

<!-- <!-- p1 <- scatter_plot_mutct(data = data, xcol = "sum_pred", ycol = "obs_sum",title = "smashgen prediction") --> -->
<!-- <!-- p2 <- scatter_plot_mutct(data = data, xcol = "rl_rescaled_sum", ycol = "obs_sum",title = "Roulette baseline") --> -->

<!-- <!-- grid.arrange(p1, p2, ncol = 2) --> -->
<!-- <!-- ``` --> -->

<!-- <!-- ### 50kb --> -->

<!-- <!-- ```{r} --> -->

<!-- <!-- load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_50kb_fitted_testpred_chr_halftt_binsz_100.rdata") --> -->

<!-- <!-- df_per_window_data$sum_pred <- df_per_window_data$randeff_est*df_per_window_data$rl_rescaled_sum --> -->
<!-- <!-- data <- df_per_window_data[complete.cases(df_per_window_data$test_pred),] --> -->

<!-- <!-- DT::datatable(data,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Details for each window'),options = list(pageLength = 5) ) --> -->

<!-- <!-- p1 <- scatter_plot_mutct(data = data, xcol = "sum_pred", ycol = "obs_sum",title = "smashgen prediction") --> -->
<!-- <!-- p2 <- scatter_plot_mutct(data = data, xcol = "rl_rescaled_sum", ycol = "obs_sum",title = "Roulette baseline") --> -->

<!-- <!-- grid.arrange(p1, p2, ncol = 2) --> -->
<!-- <!-- ``` --> -->


<!-- <!-- ### 100kb --> -->

<!-- <!-- ```{r} --> -->

<!-- <!-- load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_100kb_fitted_testpred_chr_halftt_binsz_100.rdata") --> -->

<!-- <!-- df_per_window_data$sum_pred <- df_per_window_data$randeff_est*df_per_window_data$rl_rescaled_sum --> -->
<!-- <!-- data <- df_per_window_data[complete.cases(df_per_window_data$test_pred),] --> -->

<!-- <!-- DT::datatable(data,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Details for each window'),options = list(pageLength = 5) ) --> -->

<!-- <!-- p1 <- scatter_plot_mutct(data = data, xcol = "sum_pred", ycol = "obs_sum",title = "smashgen prediction") --> -->
<!-- <!-- p2 <- scatter_plot_mutct(data = data, xcol = "rl_rescaled_sum", ycol = "obs_sum",title = "Roulette baseline") --> -->

<!-- <!-- grid.arrange(p1, p2, ncol = 2) --> -->
<!-- <!-- ``` --> -->

<!-- ## Cross validation -->

<!-- We partition each window into 100bp bins, use odd bins to train the local effect, and test on the even bins -->

<!-- * Run smashgen on the training data, to get an estimation for the local random effects -->

<!-- `fit = ebps(df_seg_non0$obs_train,df_seg_non0$rl_rescaled_train,smooth_control = list(wave_trans='ndwt',ndwt_method='smash'), general_control = list(verbose=T,printevery=1, maxiter=50))` -->

<!-- * Predict the mutation rate on testing data, based on the rescaled Roulette estimation. -->

<!-- `df_per_window_data$test_pred <- df_per_window_data$randeff_est_train*df_per_window_data$rl_rescaled_test` -->



<!-- ### 10kb -->

<!-- ```{r} -->

<!-- load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_10kb_fitted_testpred_chr_halftt_binsz_100.rdata") -->

<!-- data <- df_per_window_data[complete.cases(df_per_window_data$test_pred),] -->

<!-- DT::datatable(data,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Details for each window'),options = list(pageLength = 5) ) -->

<!-- p1 <- scatter_plot_mutct(data = data, xcol = "test_pred", ycol = "obs_test",title = "smashgen prediction") -->
<!-- p2 <- scatter_plot_mutct(data = data, xcol = "rl_rescaled_test", ycol = "obs_test",title = "Roulette baseline") -->

<!-- grid.arrange(p1, p2, ncol = 2) -->
<!-- ``` -->

<!-- ### 30kb -->

<!-- ```{r} -->

<!-- load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_30kb_fitted_testpred_chr_halftt_binsz_100.rdata") -->

<!-- data <- df_per_window_data[complete.cases(df_per_window_data$test_pred),] -->

<!-- DT::datatable(data,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Details for each window'),options = list(pageLength = 5) ) -->

<!-- p1 <- scatter_plot_mutct(data = data, xcol = "test_pred", ycol = "obs_test",title = "smashgen prediction") -->
<!-- p2 <- scatter_plot_mutct(data = data, xcol = "rl_rescaled_test", ycol = "obs_test",title = "Roulette baseline") -->

<!-- grid.arrange(p1, p2, ncol = 2) -->
<!-- ``` -->


<!-- ### 50kb -->

<!-- ```{r} -->

<!-- load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_50kb_fitted_testpred_chr_halftt_binsz_100.rdata") -->

<!-- data <- df_per_window_data[complete.cases(df_per_window_data$test_pred),] -->

<!-- DT::datatable(data,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Details for each window'),options = list(pageLength = 5) ) -->

<!-- p1 <- scatter_plot_mutct(data = data, xcol = "test_pred", ycol = "obs_test",title = "smashgen prediction") -->
<!-- p2 <- scatter_plot_mutct(data = data, xcol = "rl_rescaled_test", ycol = "obs_test",title = "Roulette baseline") -->

<!-- grid.arrange(p1, p2, ncol = 2) -->
<!-- ``` -->


<!-- ### 100kb -->

<!-- ```{r} -->

<!-- load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_100kb_fitted_testpred_chr_halftt_binsz_100.rdata") -->

<!-- data <- df_per_window_data[complete.cases(df_per_window_data$test_pred),] -->

<!-- DT::datatable(data,caption = htmltools::tags$caption( style = 'caption-side: left; text-align: left; color:black;  font-size:150% ;','Details for each window'),options = list(pageLength = 5) ) -->

<!-- p1 <- scatter_plot_mutct(data = data, xcol = "test_pred", ycol = "obs_test",title = "smashgen prediction") -->
<!-- p2 <- scatter_plot_mutct(data = data, xcol = "rl_rescaled_test", ycol = "obs_test",title = "Roulette baseline") -->

<!-- grid.arrange(p1, p2, ncol = 2) -->
<!-- ``` -->



<!-- # Comparing the random effects estimated by smashgen for setting 1 and 2 -->

<!-- ### 10kb -->

<!-- ```{r message=FALSE, warning=FALSE} -->

<!-- df_seg <- get(load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_10kb_fitted_testpred_halftt_binsz_100.rdata")) -->
<!-- df_chr <- get(load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_10kb_fitted_testpred_chr_halftt_binsz_100.rdata")) -->


<!-- df_compare <- data.frame(seg_est = df_seg$randeff_est, -->
<!--                          chr_est = df_chr$randeff_est, -->
<!--                          fold_change = df_seg$obs_sum/df_seg$randeff_est, -->
<!--                          window_start = df_seg$Window_Start) -->


<!-- ggplot(data = df_compare) +aes(x=seg_est,y=chr_est) + -->
<!--   geom_point() + -->
<!--   labs(x = "random effects estimated from partitioned segments", -->
<!--        y= "random effects estimated from whole chromosome") + -->
<!--   geom_abline(slope = 1, intercept = 0, col="red") + -->
<!--   theme_minimal() -->

<!-- ggplot(df_compare, aes(x =  window_start/1000000)) + -->
<!--   geom_line(aes(y = seg_est, color = "estimated from partitioned segments"), alpha = 0.4) + -->
<!--   geom_line(aes(y = chr_est, color = "estimated from whole chr"), alpha = 0.3) + -->
<!--   geom_line(aes(y = fold_change, color = "observed fold change"), alpha = 0.1) + -->
<!--   labs(x = "gemonic position (mb)", -->
<!--        y = "estimated random effects") + -->
<!--   scale_color_manual(name = "Group", -->
<!--                      values = c("estimated from partitioned segments" = "blue", -->
<!--                                 "estimated from whole chr" = "green", "observed fold change" = "red"), -->
<!--                      labels = c("estimated from partitioned segments","estimated from whole chr", "observed fold change")) + -->
<!--   theme_minimal() -->


<!-- ``` -->

<!-- ### 30kb -->

<!-- ```{r message=FALSE, warning=FALSE} -->

<!-- df_seg <- get(load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_30kb_fitted_testpred_halftt_binsz_100.rdata")) -->
<!-- df_chr <- get(load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_30kb_fitted_testpred_chr_halftt_binsz_100.rdata")) -->


<!-- df_compare <- data.frame(seg_est = df_seg$randeff_est, -->
<!--                          chr_est = df_chr$randeff_est, -->
<!--                          fold_change = df_seg$obs_sum/df_seg$randeff_est, -->
<!--                          window_start = df_seg$Window_Start) -->


<!-- ggplot(data = df_compare) +aes(x=seg_est,y=chr_est) + -->
<!--   geom_point() + -->
<!--   labs(x = "random effects estimated from partitioned segments", -->
<!--        y= "random effects estimated from whole chromosome") + -->
<!--   geom_abline(slope = 1, intercept = 0, col="red") + -->
<!--   theme_minimal() -->

<!-- ggplot(df_compare, aes(x =  window_start/1000000)) + -->
<!--   geom_line(aes(y = seg_est, color = "estimated from partitioned segments"), alpha = 0.4) + -->
<!--   geom_line(aes(y = chr_est, color = "estimated from whole chr"), alpha = 0.3) + -->
<!--   geom_line(aes(y = fold_change, color = "observed fold change"), alpha = 0.1) + -->
<!--   labs(x = "gemonic position (mb)", -->
<!--        y = "estimated random effects") + -->
<!--   scale_color_manual(name = "Group", -->
<!--                      values = c("estimated from partitioned segments" = "blue", -->
<!--                                 "estimated from whole chr" = "green", "observed fold change" = "red"), -->
<!--                      labels = c("estimated from partitioned segments","estimated from whole chr", "observed fold change")) + -->
<!--   theme_minimal() -->


<!-- ``` -->

<!-- ### 50kb -->


<!-- ```{r message=FALSE, warning=FALSE} -->

<!-- df_seg <- get(load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_50kb_fitted_testpred_halftt_binsz_100.rdata")) -->
<!-- df_chr <- get(load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_50kb_fitted_testpred_chr_halftt_binsz_100.rdata")) -->


<!-- df_compare <- data.frame(seg_est = df_seg$randeff_est, -->
<!--                          chr_est = df_chr$randeff_est, -->
<!--                          fold_change = df_seg$obs_sum/df_seg$randeff_est, -->
<!--                          window_start = df_seg$Window_Start) -->


<!-- ggplot(data = df_compare) +aes(x=seg_est,y=chr_est) + -->
<!--   geom_point() + -->
<!--   labs(x = "random effects estimated from partitioned segments", -->
<!--        y= "random effects estimated from whole chromosome") + -->
<!--   geom_abline(slope = 1, intercept = 0, col="red") + -->
<!--   theme_minimal() -->

<!-- ggplot(df_compare, aes(x =  window_start/1000000)) + -->
<!--   geom_line(aes(y = seg_est, color = "estimated from partitioned segments"), alpha = 0.4) + -->
<!--   geom_line(aes(y = chr_est, color = "estimated from whole chr"), alpha = 0.3) + -->
<!--   geom_line(aes(y = fold_change, color = "observed fold change"), alpha = 0.1) + -->
<!--   labs(x = "gemonic position (mb)", -->
<!--        y = "estimated random effects") + -->
<!--   scale_color_manual(name = "Group", -->
<!--                      values = c("estimated from partitioned segments" = "blue", -->
<!--                                 "estimated from whole chr" = "green", "observed fold change" = "red"), -->
<!--                      labels = c("estimated from partitioned segments","estimated from whole chr", "observed fold change")) + -->
<!--   theme_minimal() -->


<!-- ``` -->


<!-- ### 100kb -->

<!-- ```{r message=FALSE, warning=FALSE} -->

<!-- df_seg <- get(load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_100kb_fitted_testpred_halftt_binsz_100.rdata")) -->
<!-- df_chr <- get(load("/project/xinhe/xsun/mutation_rate/11.denovo_real_mssng/results/mssng_trost_per_window_chr1_100kb_fitted_testpred_chr_halftt_binsz_100.rdata")) -->


<!-- df_compare <- data.frame(seg_est = df_seg$randeff_est, -->
<!--                          chr_est = df_chr$randeff_est, -->
<!--                          fold_change = df_seg$obs_sum/df_seg$randeff_est, -->
<!--                          window_start = df_seg$Window_Start) -->


<!-- ggplot(data = df_compare) +aes(x=seg_est,y=chr_est) + -->
<!--   geom_point() + -->
<!--   labs(x = "random effects estimated from partitioned segments", -->
<!--        y= "random effects estimated from whole chromosome") + -->
<!--   geom_abline(slope = 1, intercept = 0, col="red") + -->
<!--   theme_minimal() -->

<!-- ggplot(df_compare, aes(x =  window_start/1000000)) + -->
<!--   geom_line(aes(y = seg_est, color = "estimated from partitioned segments"), alpha = 0.4) + -->
<!--   geom_line(aes(y = chr_est, color = "estimated from whole chr"), alpha = 0.3) + -->
<!--   geom_line(aes(y = fold_change, color = "observed fold change"), alpha = 0.1) + -->
<!--   labs(x = "gemonic position (mb)", -->
<!--        y = "estimated random effects") + -->
<!--   scale_color_manual(name = "Group", -->
<!--                      values = c("estimated from partitioned segments" = "blue", -->
<!--                                 "estimated from whole chr" = "green", "observed fold change" = "red"), -->
<!--                      labels = c("estimated from partitioned segments","estimated from whole chr", "observed fold change")) + -->
<!--   theme_minimal() -->


<!-- ``` -->